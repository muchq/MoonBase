name: Auto-tag impact-mcp version

on:
  workflow_run:
    workflows: ["Test + Publish"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: write

jobs:
  check-and-tag:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2  # Need previous commit to compare

      - name: Check if version changed
        id: version_check
        run: |
          # Get version from current commit
          CURRENT_VERSION=$(grep '^version = ' domains/ai/apps/impact_mcp/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')

          # Get version from previous commit
          git checkout HEAD~1 -- domains/ai/apps/impact_mcp/Cargo.toml 2>/dev/null || true
          PREVIOUS_VERSION=$(grep '^version = ' domains/ai/apps/impact_mcp/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/' || echo "")

          # Restore current version
          git checkout HEAD -- domains/ai/apps/impact_mcp/Cargo.toml

          echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "previous_version=$PREVIOUS_VERSION" >> "$GITHUB_OUTPUT"

          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ] && [ -n "$CURRENT_VERSION" ]; then
            echo "Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "Version unchanged: $CURRENT_VERSION"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push tag
        if: steps.version_check.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version_check.outputs.current_version }}"
          TAG="impact-mcp-v${VERSION}"

          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "Release impact-mcp v${VERSION}"
          git push origin "$TAG"

          echo "Created and pushed tag: $TAG"
